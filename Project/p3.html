<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">

<form action="/~s194253/02561_project/project_main.html">
  <button class="btn btn-primary btn-lg">Go back</button>
</form>
<br>
<h1>Planar Reflector - Part 2</h1>
<title>Part 2</title>

<!--
VERTEX SHADER - GROUND
-->

<script id="vertex-shader-ground" type="x-shader/x-vertex">

  precision mediump float;  
  
  attribute vec3 vPosition;
  attribute vec2 vTexel;
  varying vec2 fTexCoord;
  varying vec3 fPosition;

  uniform mat4 viewMatrix;
  uniform mat4 projectionMatrix;
  uniform mat4 modelMatrix;
  
  void main() {

    fTexCoord = vTexel;
    fPosition = vPosition;

    gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(vPosition, 1.0);
    gl_PointSize = 20.0;
    
  }
  
</script>

<!--
FRAGMENT SHADER - GROUND
-->

<script id="fragment-shader-ground" type="x-shader/x-fragment">

  precision mediump float;

  uniform sampler2D texMap;
  uniform sampler2D u_ShadowMap;

  varying vec2 fTexCoord;
  varying vec3 fPosition;

  uniform float visibility;
  uniform float alpha;

  uniform mat4 modelMatrix;
  uniform mat4 projectionMatrix;
  uniform mat4 viewMatrixFromLight;

  void main() {

    // Marble texture
    vec4 tex = texture2D(texMap, fTexCoord);
    vec4 marble = vec4(tex.xyz, alpha);

    vec4 v_PositionFromLight = projectionMatrix * viewMatrixFromLight * modelMatrix * vec4(fPosition, 1.0);
    vec3 shadowCoord = (v_PositionFromLight.xyz/v_PositionFromLight.w) / 2.0 + 0.5;

    vec4 rgbaDepth = texture2D(u_ShadowMap, shadowCoord.xy);

    float depth = rgbaDepth.r; // Retrieve the z value from R

    float visibility = (shadowCoord.z > depth + 0.005) ? 1.0 : 0.7;

    gl_FragColor = vec4(marble.rgb * visibility, marble.a); // marble -> depth, rgba -> white?

  }
</script>

<!--
VERTEX SHADER - TEAPOT
-->

<script id="vertex-shader-teapot" type="x-shader/x-vertex">

  precision mediump float;  
  
  attribute vec3 vPosition;
  attribute vec3 vNormals;
  attribute vec4 vColor;
  attribute vec3 planarNormals;
  
  varying vec3 fPosition;
  varying vec3 fNormals;
  varying vec4 fColor;

  // VPM
  uniform mat4 viewMatrix;
  uniform mat4 projectionMatrix;
  uniform mat4 modelMatrix;

  uniform bool reflected;

  void main() {

    vec3 up = vec3(0.0, 1.0, 0.0);

    mat4 R;
    mat4 I = mat4(1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0);

    // Construct reflection matrix
    R[0][0] = 1.0 - 2.0 * up.x * up.x; 
    R[1][0] = - 2.0 * up.x * up.y;
    R[2][0] = - 2.0 * up.x * up.z;
    R[3][0] = 2.0 * dot(vec3(vPosition.x, -1.0, vPosition.z), up) * up.x;

    R[0][1] = - 2.0 * up.x * up.y; 
    R[1][1] = 1.0 - 2.0 * up.y * up.y;
    R[2][1] = - 2.0 * up.y * up.z;
    R[3][1] = 2.0 * dot(vec3(vPosition.x, -1.0, vPosition.z), up) * up.y;

    R[0][2] = - 2.0 * up.x * up.z; 
    R[1][2] = - 2.0 * up.y * up.z;
    R[2][2] = 1.0 - 2.0 * up.z * up.z;
    R[3][2] = 2.0 * dot(vec3(vPosition.x, -1.0, vPosition.z), up) * up.z;

    R[0][3] = 0.0;
    R[1][3] = 0.0;
    R[2][3] = 0.0;
    R[3][3] = 1.0;

    // Sending position, normal and color to fragment
    fPosition =  vPosition;
    fNormals =  vNormals;
    fColor = vColor;

    gl_Position = projectionMatrix * (reflected ? R:I) * viewMatrix * modelMatrix * vec4(vPosition, 1.0);
    gl_PointSize = 20.0;

  }
  
</script>

<!--
FRAGMENT SHADER - TEAPOT
-->

<script id="fragment-shader-teapot" type="x-shader/x-fragment">

  precision mediump float;

  varying vec3 fPosition;
  varying vec3 fNormals;
  varying vec4 fColor;

  uniform vec4 lightPos;
  uniform vec3 L_i;
  uniform float k_a;
  uniform float k_d;
  uniform float k_s;
  uniform float s;

  uniform float visibility;
  //uniform int use_reflection;

  // VPM
  uniform mat4 viewMatrix;
  uniform mat4 projectionMatrix;
  uniform mat4 modelMatrix;

  void main() {
    
    vec4 pos = (modelMatrix * viewMatrix * vec4(fPosition, 1.0)); // evt. viewMatrix? (model ifÃ¸lge wiki)
    vec4 normals = (modelMatrix * viewMatrix * vec4(fNormals, 0.0));

    vec3 light = (viewMatrix * lightPos).xyz;
    vec3 w_i = lightPos.w == 0.0 ? normalize(light) : normalize(light - pos.xyz);

    vec3 w_r = 2.0 * dot(w_i, normalize(normals.xyz)) * normalize(normals.xyz) - w_i;

    vec3 w_o = -normalize((viewMatrix * pos).xyz); 

    vec3 L_rd = k_d * L_i * max(dot(normals.xyz, w_i), 0.0) * fColor.xyz; // 'color' exchanged with white-RGB 
    vec3 L_rs = k_s * L_i * pow(max(dot(w_r, w_o), 0.0), s) * float(dot(w_i, normalize(normals.xyz)) > 0.0); 

    vec3 L_ra = k_a * L_i;
    
    vec3 L_o = L_rd + L_rs + L_ra;

    gl_FragColor = vec4((visibility * L_o).xyz, 1.0); 
  }
  
</script>


<!--
VERTEX SHADER - SHADOWS
-->

<script id="vShadows" type="x-shader/x-vertex">

  precision mediump float;  
  
  attribute vec4 vPosition;

  uniform mat4 viewMatrix;
  uniform mat4 projectionMatrix;
  uniform mat4 modelMatrix;

  
  void main() {

    gl_Position = projectionMatrix * viewMatrix * modelMatrix * vPosition;

  }
  
</script>

<!--
FRAGMENT SHADER - SHADOWS
-->

<script id="fShadows" type="x-shader/x-fragment">
  
  precision mediump float; void main() {
    
    const vec4 bitShift = vec4(1.0, 256.0, 256.0*256.0, 256.0*256.0*256.0); 

    const vec4 bitMask = vec4(1.0/256.0, 1.0/256.0, 1.0/256.0, 0.0);

    vec4 rgbaDepth = fract(gl_FragCoord.z*bitShift);

    rgbaDepth -= rgbaDepth.gbaa*bitMask;

    gl_FragColor = rgbaDepth; 

  }

</script>



<script type="text/javascript" src="../common/webgl-utils.js"></script>
<script type="text/javascript" src="../common/initShaders.js"></script>
<script type="text/javascript" src="../common/MV.js"></script>
<script type="text/javascript" src="../common/OBJParser.js"></script> 
<script type="text/javascript" src="p3.js"></script>
</head>

<div>
<body>
  <canvas id="c" width="512" height="512">
  </canvas>
</body> <br>
</div>

<button id = "Orbit">Lighting orbit On/Off</button>
<button id = "Jump">Teapot jump On/Off</button>

<!--this is a comment-->
</html>

